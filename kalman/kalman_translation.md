===== 第1页 =====

讲座笔记

Ramsey Faragher

通过简单直观的推导理解卡尔曼滤波的基础

本文提供了一个简单直观的卡尔曼滤波推导方法，旨在向数学背景不强的学生教授这一实用工具。理解此推导所需的最复杂数学能力仅为将两个高斯函数相乘并将结果简化为紧凑形式。

卡尔曼滤波已有50多年的历史，但至今仍是最重要和常用的数据融合算法之一。它以Rudolf E. Kalman的名字命名，其巨大成功归功于其计算量小、递归特性优雅，以及其作为具有高斯误差统计的一维线性系统最优估计器的地位[1]。卡尔曼滤波的典型用途包括平滑噪声数据并提供感兴趣参数的估计。应用领域包括全球定位系统接收器、无线电设备中的锁相环、笔记本电脑触控板的输出平滑等。

从理论角度来看，卡尔曼滤波是一种允许在线性动态系统中进行精确推断的算法，这是一种类似于隐马尔可夫模型的贝叶斯模型，但其潜在变量的状态空间是连续的，且所有潜在变量和观测变量均服从高斯分布（通常是多元高斯分布）。本讲座笔记的目的是让那些对此描述感到困惑或畏惧的人通过简单直观的推导理解卡尔曼滤波的基础。

**相关性**
卡尔曼滤波[2]（及其变体，如扩展卡尔曼滤波[3]和无迹卡尔曼滤波[4]）是信息处理领域中最著名和流行的数据融合算法之一。卡尔曼滤波最著名的早期应用是在阿波罗导航计算机中，该计算机将尼尔·阿姆斯特朗送上月球，并（最重要的是）将他带回地球。如今，卡尔曼滤波应用于每台卫星导航设备、每部智能手机以及许多电脑游戏中。

**卡尔曼滤波已有50多年的历史，但至今仍是最重要和常用的数据融合算法之一。**

卡尔曼滤波通常使用向量代数作为最小均方估计器来推导[5]，这种方法适合数学基础扎实的学生，但对于数学要求不高的学科学生来说不易理解。本文通过一个简单的物理示例，利用高斯分布的一个关键特性——即两个高斯分布的乘积仍是高斯分布——从基本原理出发推导卡尔曼滤波。

**预备知识**
本文并非为卡尔曼滤波的完全新手设计，为简洁起见，其目的是为教师提供一种简单的方法，向数学基础不强的学生教授卡尔曼滤波的概念。读者需熟悉与卡尔曼滤波相关的向量符号和术语，如状态向量和协方差矩阵。本文面向那些需要以简单直观的方式向他人教授卡尔曼滤波的人，或那些已有卡尔曼滤波经验但可能未完全理解其基础的人。本文并非为完全新手设计的全面独立教育工具，因为那需要一章而非几页的篇幅来传达。

**问题陈述**
卡尔曼滤波模型假设系统在时间 $t$ 的状态由时间 $t-1$ 的先前状态根据以下方程演化：


$$
\mathbf{x}_t = \mathbf{F}_t\mathbf{x}_{t-1} + \mathbf{B}_t\mathbf{u}_t + \mathbf{w}_t,
$$


其中：
-  $\mathbf{x}_t$ 是状态向量，包含系统在时间 $t$ 的感兴趣项（如位置、速度、航向）。
-  $\mathbf{u}_t$ 是包含任何控制输入（转向角、油门设置、制动力）的向量。
-  $\mathbf{F}_t$ 是状态转移矩阵，用于将时间 $t-1$ 的每个系统状态参数对时间 $t$ 的系统状态的影响（例如，时间 $t-1$ 的位置和速度均会影响时间 $t$ 的位置）。
-  $\mathbf{B}_t$ 是控制输入矩阵，用于将向量 $\mathbf{u}$ 中的每个控制输入参数对状态向量的影响（例如，油门设置对系统速度和位置的影响）。
-  $\mathbf{w}_t$ 是包含状态向量中每个参数的过程噪声项的向量。过程噪声假设来自均值为零的多元正态分布，其协方差由协方差矩阵 $\mathbf{Q}$ 给出。

系统的测量也可以根据以下模型进行：


$$
\mathbf{z}_t = \mathbf{H}_t \mathbf{x}_t + \mathbf{v}_t,
$$


其中：
-  $\mathbf{z}_t$ 是测量向量。
-  $\mathbf{H}_t$ 是将状态向量参数映射到测量域的变换矩阵。
-  $\mathbf{v}_t$ 是包含测量向量中每个观测值的测量噪声项的向量。与过程噪声类似，测量噪声假设为零均值高斯白噪声，其协方差为 $\mathbf{R}_t$ 。

在接下来的推导中，我们将考虑一个简单的一维跟踪问题，特别是沿铁路线移动的火车（见图1）。因此，我们可以考虑此问题中的一些示例向量和矩阵。状态向量 $\mathbf{x}_t$ 包含火车的位置和速度：


$$
\mathbf{x}_t =
\begin{bmatrix}
x_t \\
\dot{x}_t
\end{bmatrix}.
$$


火车驾驶员可能会对系统施加制动或加速输入，这里我们将其视为施加力 $f_t$ 和火车质量 $m$ 的函数。此类控制信息存储在控制向量 $\mathbf{u}_t$ 中：


$$
\mathbf{u}_t = \frac{f_t}{m}.
$$


通过制动器或油门在时间周期 $\Delta t$ （时间 $t-1$ 和 $t$ 之间经过的时间）内施加的力与火车位置和速度之间的关系由以下方程给出：


$$
x_t = x_{t-1} + (\dot{x}_{t-1} \times \Delta t) + \frac{f_t(\Delta t)^2}{2m},
$$


$$
\dot{x}_t = \dot{x}_{t-1} + \frac{f_t \Delta t}{m}.
$$


这些线性方程可以写成矩阵形式：


$$
\begin{bmatrix}
x_t \\
\dot{x}_t
\end{bmatrix} =
\begin{bmatrix}
1 & \Delta t \\
0 & 1
\end{bmatrix}
\begin{bmatrix}
x_{t-1} \\
\dot{x}_{t-1}
\end{bmatrix} +
\begin{bmatrix}
\frac{(\Delta t)^2}{2} \\
\Delta t
\end{bmatrix}
\frac{f_t}{m}.
$$


因此，通过与(1)比较，我们可以看到在此示例中：


$$
\mathbf{F}_t =
\begin{bmatrix}
1 & \Delta t \\
0 & 1
\end{bmatrix}
\text{和}
\mathbf{B}_t =
\begin{bmatrix}
\frac{(\Delta t)^2}{2} \\
\Delta t
\end{bmatrix}.
$$


系统的真实状态 $\mathbf{x}_t$ 无法直接观测，卡尔曼滤波提供了一种算法，通过结合系统模型和某些参数或参数的线性函数的噪声测量来确定估计值 $\hat{\mathbf{x}}_t$ 。因此，状态向量中感兴趣参数的估计现在由概率密度函数（pdf）而非离散值提供。卡尔曼滤波基于高斯pdf，如下面的“解决方案”部分所述。为了完全描述高斯函数，我们需要知道它们的方差和协方差，这些信息存储在协方差矩阵 $\mathbf{P}_t$ 中。 $\mathbf{P}_t$ 的主对角线上的项是与状态向量中相应项相关的方差。 $\mathbf{P}_t$ 的非对角线项提供了状态向量中各项之间的协方差。对于具有从零均值高斯分布中提取的测量误差的建模良好的一维线性系统，卡尔曼滤波已被证明是最优估计器[1]。在本文的其余部分，我们将推导卡尔曼滤波方程，这些方程允许我们通过结合先验知识、系统模型的预测和噪声测量来递归计算 $\hat{\mathbf{x}}_t$ 。

卡尔曼滤波算法涉及两个阶段：预测和测量更新。预测阶段的标准卡尔曼滤波方程为：


$$
\hat{\mathbf{x}}_{t|t-1} = \mathbf{F}_t \hat{\mathbf{x}}_{t-1|t-1} + \mathbf{B}_t \mathbf{u}_t,
$$


$$
\mathbf{P}_{t|t-1} = \mathbf{F}_t \mathbf{P}_{t-1|t-1} \mathbf{F}_t^T + \mathbf{Q}_t,
$$


其中 $\mathbf{Q}_t$ 是与噪声控制输入相关的过程噪声协方差矩阵。方程(3)在上面已明确推导。我们可以如下推导(4)。对未知真实值 $x_t$ 的预测 $\hat{\mathbf{x}}_{t|t-1}$ 的方差由下式给出：


$$
P_{t|t-1} = E[(\mathbf{x}_t - \hat{\mathbf{x}}_{t|t-1})(\mathbf{x}_t - \hat{\mathbf{x}}_{t|t-1})^T],
$$


取(3)和(1)之间的差值得到：

---

**测量（含噪声）**

0

**预测（估计）**

---

[图1] 此图展示了所考虑的一维系统。

IEEE SIGNAL PROCESSING MAGAZINE [129] SEPTEMBER 2012

===== 第2页 =====

[图2] 系统在时间 $t = 0$ 的初始知识。红色高斯分布表示提供火车位置估计初始置信度的pdf。向右的箭头表示火车的已知初始速度。


$$
x_t - \hat{x}_{t|t-1} = F(x_{t-1} - \hat{x}_{t-1|t-1}) + w_t
$$


$$
\Rightarrow P_{t|t-1} = E[(F(x_{t-1} - \hat{x}_{t-1|t-1}) + w_t) \times (F(x_{t-1} - \hat{x}_{t-1|t-1}) + w_t)^T]
$$


$$
= FE[(x_{t-1} - \hat{x}_{t-1|t-1}) \times (x_{t-1} - \hat{x}_{t-1|t-1})^T]
$$


$$
\times F^T + FE[(x_{t-1} - \hat{x}_{t-1|t-1})w_t^T]
$$


$$
+ E[w_t (x_{t-1} - \hat{x}_{t-1|t-1})^T]F^T
$$


$$
+ E[w_t w_t^T].
$$


注意到状态估计误差和过程噪声不相关：


$$
E[(x_{t-1} - \hat{x}_{t-1|t-1})w_t^T] = E[w_t (x_{t-1} - \hat{x}_{t-1|t-1})^T] = 0
$$


$$
\Rightarrow P_{t|t-1} = FE[(x_{t-1} - \hat{x}_{t-1|t-1}) (x_{t-1} - \hat{x}_{t-1|t-1})^T]F^T + E[w_t w_t^T]
$$


$$
\Rightarrow P_{t|t-1} = FP_{t-1|t-1}F^T + Q_t.
$$


测量更新方程由下式给出：


$$
\hat{x}_{t|t} = \hat{x}_{t|t-1} + K_t(z_t - H_t \hat{x}_{t|t-1}),
$$


$$
P_{t|t} = P_{t|t-1} - K_tH_tP_{t|t-1},
$$


其中：


$$
K_t = P_{t|t-1}H_t^T(H_tP_{t|t-1}H_t^T + R_t)^{-1}.
$$


在本文的其余部分，我们将从基本原理推导测量更新方程[(5)-(7)]。

**解决方案**
卡尔曼滤波将通过一个简单的一维跟踪问题来推导，特别是沿铁路线移动的火车。在每个测量时刻，我们希望形成一个部署在轨道旁的无线电测距系统。预测和测量的信息被结合起来，以提供火车位置的最佳可能估计。该系统如图1所示。

系统的初始状态（在时间 $t = 0$ 秒）已知具有合理的准确性，如图2所示。火车的位置由高斯pdf给出。在下一个时间时刻（ $t = 1$ 秒），我们可以根据已知的限制（如其位置和在 $t = 0$ 时的速度、最大可能的加速和减速等）估计火车的新位置。实际上，我们可能对驾驶员通过制动器或油门的控制输入有一些了解。无论如何，我们有一个火车新位置的预测，如图3中具有新均值和高斯pdf表示。数学上，此步骤由(1)表示。方差增加了[见(2)]，表示我们对位置估计准确性的确定性相比 $t = 0$ 时降低，这是由于从时间 $t = 0$ 到时间 $t = 1$ 期间进行的加速或减速的任何过程噪声的不确定性。

**我们能够对火车位置做出的最佳估计是通过结合来自预测和测量的知识来提供的。**

知道火车（或更准确地说，火车车顶上的无线电天线）位置的最佳可能估计。信息来自两个来源：1)基于火车最后已知位置和速度的预测；2)测量。

[图3] 这里展示了在时间 $t = 1$ 时火车位置的预测以及该预测的不确定性水平。对火车位置知识的置信度降低了，因为我们不确定火车在从 $t = 0$ 到 $t = 1$ 的间隔期间是否进行了任何加速或减速。

IEEE SIGNAL PROCESSING MAGAZINE | 130 | SEPTEMBER 2012

===== 第3页 =====

**测量（含噪声）**

**预测（估计）**

???

[图4] 展示了在时间 $t = 1$ 时火车位置的测量以及该噪声测量的不确定性水平，由蓝色高斯pdf表示。该系统的新知识是通过将这两个pdf相乘得到的。

**预测（估计）**

**测量（含噪声）**

???

[图5] 展示了通过将火车位置在时间 $t = 1$ 的预测和测量的pdf相乘生成的新pdf（绿色）。这个新pdf通过融合来自预测和测量的数据，提供了火车位置的最佳估计。

在 $t = 1$ 时，我们还使用无线电定位系统对火车的位置进行了测量，这由图4中的蓝色高斯pdf表示。我们能够对火车位置做出的最佳估计是通过结合来自预测和测量的知识来提供的。这是通过将两个相应的pdf相乘来实现的。这由图5中的绿色pdf表示。

此时利用了高斯函数的一个关键特性：两个高斯函数的乘积是另一个高斯函数。这一点至关重要，因为它允许在时间上无限次地相乘高斯pdf，但结果函数的复杂性或项数不会增加；每个时间时刻后，新的pdf完全由高斯函数表示。这是卡尔曼滤波优雅递归特性的关键。

现在再次从数学角度考虑上述图中的阶段，以推导卡尔曼滤波测量更新方程。

图3中红色高斯函数表示的预测pdf由以下方程给出：


$$
y_1(r; \mu_1, \sigma_1) \triangleq \frac{1}{\sqrt{2\pi\sigma_1^2}} e^{-\frac{(r - \mu_1)^2}{2\sigma_1^2}}.
$$


图4中蓝色高斯函数表示的测量pdf由以下方程给出：


$$
y_2(r; \mu_2, \sigma_2) \triangleq \frac{1}{\sqrt{2\pi\sigma_2^2}} e^{-\frac{(r - \mu_2)^2}{2\sigma_2^2}}.
$$


通过将这两个pdf相乘，即同时考虑预测和测量（见图5），融合了这两个pdf提供的信息。因此，表示预测和测量信息融合的新pdf以及我们对系统的最佳当前估计由这两个高斯函数的乘积给出：


$$
y_{\text{fused}}(r; \mu_1, \sigma_1, \mu_2, \sigma_2) = \frac{1}{\sqrt{2\pi\sigma_1^2}} e^{-\frac{(r - \mu_1)^2}{2\sigma_1^2}} \times \frac{1}{\sqrt{2\pi\sigma_2^2}} e^{-\frac{(r - \mu_2)^2}{2\sigma_2^2}}
$$


$$
= \frac{1}{2\pi\sqrt{\sigma_1^2\sigma_2^2}} e^{-\left(\frac{(r - \mu_1)^2}{2\sigma_1^2} + \frac{(r - \mu_2)^2}{2\sigma_2^2}\right)}.
$$


可以展开这个新函数中的二次项，然后将整个表达式重写为高斯形式：


$$
y_{\text{fused}}(r; \mu_{\text{fused}}, \sigma_{\text{fused}}) = \frac{1}{\sqrt{2\pi\sigma_{\text{fused}}^2}} e^{-\frac{(r - \mu_{\text{fused}})^2}{2\sigma_{\text{fused}}^2}},
$$


其中：


$$
\mu_{\text{fused}} = \frac{\mu_1\sigma_2^2 + \mu_2\sigma_1^2}{\sigma_1^2 + \sigma_2^2} = \mu_1 + \frac{\sigma_1^2(\mu_2 - \mu_1)}{\sigma_1^2 + \sigma_2^2},
$$


$$
\sigma_{\text{fused}}^2 = \frac{\sigma_1^2\sigma_2^2}{\sigma_1^2 + \sigma_2^2} = \sigma_1^2 - \frac{\sigma_1^4}{\sigma_1^2 + \sigma_2^2}.
$$


最后这两个方程代表了卡尔曼滤波算法的测量更新步骤，如下文将明确展示的那样。然而，为了展示更一般的情况，我们需要考虑对此示例的扩展。

在上述示例中，假设预测和测量是在相同的坐标框架和单位中进行的。这导致了一对特别简洁的方程，代表了预测和测量更新阶段。然而，需要注意的是，在现实中通常需要一个函数将预测和测量映射到相同的域中。在我们示例的一个更现实的扩展中，火车的位置将直接预测为沿铁路线的新距离，单位为米，但飞行时间测量以秒为单位记录。为了让预测和测量pdf相乘，必须将其中一个转换到另一个的域中，标准做法是通过变换矩阵 $H_t$ 将预测映射到测量域。

我们现在重新审视(8)和(9)，不再让 $y_1$ 和 $y_2$ 都表示沿铁路轨道的米值，而是考虑分布 $y_2$ 表示从位于 $x = 0$ 的发射器传播到火车上天线的无线电信号的飞行时间（秒）。空间预测pdf  $y_1$ 通过将函数缩放为光速 $c$ 转换到测量域。因此，(8)和(9)必须重写为：


$$
y_1(s; \mu_1, \sigma_1, c) \triangleq \frac{1}{\sqrt{2\pi(\frac{\sigma_1}{c})^2}} e^{-\frac{(s - \frac{\mu_1}{c})^2}{2(\frac{\sigma_1}{c})^2}},
$$


$$
y_2(s; \mu_2, \sigma_2) \triangleq \frac{1}{\sqrt{2\pi\sigma_2^2}} e^{-\frac{(s - \mu_2)^2}{2\sigma_2^2}},
$$


其中两个分布现在都在测量域中定义，无线电信号沿时间“s”轴传播，测量单位为秒。

按照之前的推导，我们现在发现：


$$
\frac{\mu_{\text{fused}}}{c} = \frac{\mu_1}{c} + \frac{(\frac{\sigma_1}{c})^2 (\mu_2 - \frac{\mu_1}{c})}{(\frac{\sigma_1}{c})^2 + \sigma_2^2}
$$


$$
\Rightarrow \mu_{\text{fused}} = \mu_1 + \left( \frac{\sigma_1^2}{c} \cdot \frac{\mu_2 - \frac{\mu_1}{c}}{(\frac{\sigma_1}{c})^2 + \sigma_2^2} \right).
$$


代入 $H = 1/c$ 和 $K = (H\sigma_1^2) / (H^2\sigma_1^2 + \sigma_2^2)$ 得到：


$$
\mu_{\text{fused}} = \mu_1 + K \cdot (\mu_2 - H\mu_1).
$$


类似地，融合后的方差估计变为：


$$
\frac{\sigma_{\text{fused}}^2}{c^2} = \left( \frac{\sigma_1}{c} \right)^2 - \frac{(\frac{\sigma_1}{c})^4}{(\frac{\sigma_1}{c})^2 + \sigma_2^2}
$$


$$
\Rightarrow \sigma_{\text{fused}}^2 = \sigma_1^2 - \left( \frac{\sigma_1^2}{c} \cdot \frac{\sigma_1^2}{(\frac{\sigma_1}{c})^2 + \sigma_2^2} \right) \sigma_1^2
$$


$$
= \sigma_1^2 - kH\sigma_1^2.
$$


**卡尔曼滤波可以通过涉及标量数学、基本代数操作和易于理解的思维实验的简单推导来教授。**

我们现在可以将此标量推导的某些项与卡尔曼滤波算法中使用的标准向量和矩阵进行比较：


$$
\mu_{\text{fused}} \rightarrow \hat{x}_{i|t} \text{：数据融合后的状态向量}
$$


$$
\mu_1 \rightarrow \hat{x}_{i|t-1} \text{：数据融合前的状态向量，即预测}
$$


$$
\sigma_{\text{fused}} \rightarrow P_{i|t} \text{：数据融合后的协方差矩阵（置信度）}
$$


$$
\sigma_1^2 \rightarrow P_{i|t-1} \text{：数据融合前的协方差矩阵（置信度）}
$$


$$
\mu_2 \rightarrow z_t \text{：测量向量}
$$


$$
\sigma_2^2 \rightarrow R \text{：与噪声测量集相关的不确定性矩阵}
$$


$$
H \rightarrow H_t \text{：用于将状态向量参数映射到测量域的变换矩阵}
$$


$$
K = \frac{H\sigma_1^2}{H^2\sigma_1^2 + \sigma_2^2} \rightarrow K_t = P_{i|t-1}H_t^T(H_tP_{i|t-1}H_t^T + R_t)^{-1} \text{：卡尔曼增益}
$$


现在很容易看出标准卡尔曼滤波方程与上述(17)和(18)的关系：


$$
\mu_{\text{fused}} = \mu_1 + \left( \frac{H\sigma_1^2}{H^2\sigma_1^2 + \sigma_2^2} \right) (\mu_2 - H\mu_1)
$$


$$
\rightarrow \hat{x}_{i|t} = \hat{x}_{i|t-1} + K_t (z_t - H_t \hat{x}_{i|t-1}),
$$


$$
\sigma_{\text{fused}}^2 = \sigma_1^2 - \left( \frac{H\sigma_1^2}{H^2\sigma_1^2 + \sigma_2^2} \right) H\sigma_1^2
$$


$$
\rightarrow P_{i|t} = P_{i|t-1} - K_t H_t P_{i|t-1}.
$$


**结论**
卡尔曼滤波可以通过涉及标量数学、基本代数操作和易于理解的思维实验的简单推导来教授。这种方法应能让缺乏浓厚数学兴趣的学生以直观的方式理解卡尔曼滤波的核心数学基础，并理解滤波的递归特性是由高斯函数的独特乘法特性提供的。

**作者**
Ramsey Faragher (ramsey@cantab.net) 是英国BAE系统先进技术中心的首席科学家。

**参考文献**
[1] B. D. O. Anderson and J. B. Moore, Optimal Filtering. New York: Dover, 2005.
[2] R. E. Kalman, “A new approach to linear filtering and prediction problems,” J. Basic Eng., vol. 82, no. 1, pp. 35–45, Mar. 1960.
[3] P. D. Groves, Principles of GNSS, Inertial, and Multisensor Integrated Navigation Systems. Norwood, MA: Artech House, 2008.
[4] S. J. Julier and J. K. Uhlmann, “Unscented filtering and nonlinear estimation,” Proc. IEEE, vol. 92, no. 3, pp. 401–422, 2004.
[5] J. Bibby and H. Toutenburg, Prediction and Improved Estimation in Linear Models. New York: Wiley, 1977.

IEEE SIGNAL PROCESSING MAGAZINE [132] SEPTEMBER 2012